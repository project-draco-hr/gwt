{
  logger=logger.branch(TreeLogger.SPAM,"Checking for JavaScript native methods",null);
  if (coreTypes == null) {
    coreTypes=new CoreTypes(logger);
  }
  char[] source=cup.getSource();
  List<Replacement> changes=new ArrayList<Replacement>();
  rewriteCompilationUnit(logger,source,changes,cup,false);
  int n=changes.size();
  if (n > 0) {
    Replacement[] repls=changes.toArray(new Replacement[n]);
    Arrays.sort(repls);
    StringCopier copier=new StringCopier(source);
    for (int i=0; i < n; ++i) {
      Replacement repl=repls[i];
      copier.commit(repl.text,repl.start,repl.end);
    }
    char[] results=copier.finish();
    if (jsniSaveDirectory != null) {
      String originalPath=cup.getLocation().replace(File.separatorChar,'/');
      String suffix=cup.getPackageName().replace('.','/');
      int pos=originalPath.indexOf(suffix);
      if (pos >= 0) {
        String filePath=originalPath.substring(pos);
        File out=new File(jsniSaveDirectory,filePath);
        Util.writeCharsAsFile(logger,out,results);
      }
    }
    return new CompilationUnitProviderWithAlternateSource(cup,results);
  }
 else {
    logger.log(TreeLogger.SPAM,"No JavaScript native methods were found",null);
    return cup;
  }
}
