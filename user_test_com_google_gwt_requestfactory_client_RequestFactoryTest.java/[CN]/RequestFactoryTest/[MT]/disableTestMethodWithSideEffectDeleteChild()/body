{
  delayTestFinish(DELAY_TEST_FINISH);
  SimpleBarRequest context=req.simpleBarRequest();
  final SimpleBarProxy bar=context.create(SimpleBarProxy.class);
  context.persistAndReturnSelf().using(bar).fire(new Receiver<SimpleBarProxy>(){
    @Override public void onSuccess(    SimpleBarProxy persistentBar){
      SimpleFooRequest context=req.simpleFooRequest();
      SimpleFooProxy foo=context.create(SimpleFooProxy.class);
      final Request<SimpleFooProxy> persistRequest=context.persistAndReturnSelf().using(foo);
      foo=context.edit(foo);
      foo.setUserName("John");
      foo.setBarField(bar);
      persistRequest.fire(new Receiver<SimpleFooProxy>(){
        @Override public void onSuccess(        SimpleFooProxy persistentFoo){
          final SimpleFooEventHandler<SimpleFooProxy> fooHandler=new SimpleFooEventHandler<SimpleFooProxy>();
          EntityProxyChange.registerForProxyType(req.getEventBus(),SimpleFooProxy.class,fooHandler);
          final SimpleFooEventHandler<SimpleBarProxy> barHandler=new SimpleFooEventHandler<SimpleBarProxy>();
          EntityProxyChange.registerForProxyType(req.getEventBus(),SimpleBarProxy.class,barHandler);
          SimpleFooRequest context=req.simpleFooRequest();
          final Request<Void> deleteRequest=context.deleteBar().using(persistentFoo);
          SimpleFooProxy editable=context.edit(persistentFoo);
          editable.setBarField(bar);
          deleteRequest.fire(new Receiver<Void>(){
            @Override public void onSuccess(            Void response){
              assertEquals(1,fooHandler.updateEventCount);
              assertEquals(1,fooHandler.totalEventCount);
              assertEquals(1,barHandler.deleteEventCount);
              assertEquals(1,barHandler.totalEventCount);
              finishTestAndReset();
            }
          }
);
        }
      }
);
    }
  }
);
}
