{
  delayTestFinish(5000);
  final SimpleFooProxy foo=req.create(SimpleFooProxy.class);
  final SimpleBarProxy bar0=req.create(SimpleBarProxy.class);
  final SimpleBarProxy bar1=req.create(SimpleBarProxy.class);
  List<SimpleBarProxy> bars=new ArrayList<SimpleBarProxy>();
  bars.add(bar0);
  bars.add(bar1);
  final SimpleFooEventHandler<SimpleBarProxy> handler=new SimpleFooEventHandler<SimpleBarProxy>();
  EntityProxyChange.registerForProxyType(req.getEventBus(),SimpleBarProxy.class,handler);
  Request<SimpleFooProxy> request=req.simpleFooRequest().persistCascadingAndReturnSelf(foo);
  SimpleFooProxy editFoo=request.edit(foo);
  editFoo.setOneToManyField(bars);
  request.fire(new Receiver<SimpleFooProxy>(){
    @Override public void onSuccess(    SimpleFooProxy response){
      assertFalse(((ProxyImpl)response).unpersisted());
      assertEquals(2,handler.persistEventCount);
      assertEquals(2,handler.totalEventCount);
      finishTestAndReset();
    }
  }
);
}
