{
  SafeHtml image;
  if (isPlaceholder) {
    image=SafeHtmlUtils.fromTrustedString("<div></div>");
  }
 else {
    AbstractImagePrototype proto=AbstractImagePrototype.create(res);
    image=SafeHtmlUtils.fromTrustedString(proto.getHTML());
  }
  if (HasVerticalAlignment.ALIGN_TOP == valign) {
    return template.imageWrapperTop(direction,image);
  }
 else   if (HasVerticalAlignment.ALIGN_BOTTOM == valign) {
    return template.imageWrapperBottom(direction,image);
  }
 else {
    int halfHeight=1 + (int)Math.round(res.getHeight() / 2.0);
    return template.imageWrapperMiddle(direction,halfHeight,image);
  }
}
