{
  MockLoadStrategy reqs=new MockLoadStrategy();
  MockProgressLogger progress=new MockProgressLogger();
  int numEntries=20;
  AsyncFragmentLoader loader=new AsyncFragmentLoader(numEntries,new int[]{1,2,3},reqs,progress);
  loader.startPrefetching();
  loader.setPrefetchQueue(asList(2));
  reqs.assertFragmentsRequested(1);
  progress.assertEvent("download1",BEGIN,1);
  loader.fragmentHasLoaded(1);
  reqs.assertFragmentsRequested(2);
  progress.assertEvent("download1",END,1);
  progress.assertEvent("download2",BEGIN,2);
  loader.fragmentHasLoaded(2);
  reqs.assertFragmentsRequested();
  progress.assertEvent("download2",END,2);
  progress.assertNoEvents();
  loader.setPrefetchQueue(asList(4));
  reqs.assertFragmentsRequested(3);
  progress.assertEvent("download3",BEGIN,3);
  loader.fragmentHasLoaded(3);
  reqs.assertFragmentsRequested(numEntries);
  progress.assertEvent("download3",END,3);
  progress.assertEvent("leftoversDownload",BEGIN,numEntries);
  loader.leftoversFragmentHasLoaded();
  reqs.assertFragmentsRequested(4);
  progress.assertEvent("leftoversDownload",END,numEntries);
  progress.assertEvent("download4",BEGIN,4);
  loader.fragmentHasLoaded(4);
  reqs.assertFragmentsRequested();
  progress.assertEvent("download4",END,4);
  progress.assertNoEvents();
  loader.setPrefetchQueue(asList(5,6));
  reqs.assertFragmentsRequested(5);
  progress.assertEvent("download5",BEGIN,5);
  loader.inject(7,NULL_ERROR_HANDLER);
  reqs.assertFragmentsRequested();
  progress.assertNoEvents();
  loader.fragmentHasLoaded(5);
  reqs.assertFragmentsRequested(7);
  progress.assertEvent("download5",END,5);
  progress.assertEvent("download7",BEGIN,7);
  loader.fragmentHasLoaded(7);
  reqs.assertFragmentsRequested(6);
  progress.assertEvent("download7",END,7);
  progress.assertEvent("download6",BEGIN,6);
  loader.fragmentHasLoaded(6);
  reqs.assertFragmentsRequested();
  progress.assertEvent("download6",END,6);
  progress.assertNoEvents();
  loader.setPrefetchQueue(asList(8,9));
  reqs.assertFragmentsRequested(8);
  progress.assertEvent("download8",BEGIN,8);
  loader.setPrefetchQueue(asList(10));
  reqs.assertFragmentsRequested();
  progress.assertNoEvents();
  loader.fragmentHasLoaded(8);
  reqs.assertFragmentsRequested(10);
  progress.assertEvent("download8",END,8);
  progress.assertEvent("download10",BEGIN,10);
  loader.fragmentHasLoaded(10);
  reqs.assertFragmentsRequested();
  progress.assertEvent("download10",END,10);
  progress.assertNoEvents();
  loader.setPrefetchQueue(asList(1,3,7,10));
  reqs.assertFragmentsRequested();
  progress.assertNoEvents();
}
