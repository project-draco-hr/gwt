{
  int status=response.getStatus();
  if (status < 0) {
    status=404;
  }
  TreeLogger.Type logStatus, logHeaders;
  if (status >= 500) {
    logStatus=TreeLogger.ERROR;
    logHeaders=TreeLogger.INFO;
  }
 else   if (status == 404) {
    if ("/favicon.ico".equals(request.getRequestURI()) && request.getQueryString() == null) {
      logStatus=TreeLogger.TRACE;
      logHeaders=TreeLogger.DEBUG;
    }
 else {
      logStatus=TreeLogger.WARN;
      logHeaders=TreeLogger.INFO;
    }
  }
 else   if (status >= 400) {
    logStatus=TreeLogger.WARN;
    logHeaders=TreeLogger.INFO;
  }
 else {
    logStatus=normalLogLevel;
    logHeaders=TreeLogger.DEBUG;
  }
  String userString=request.getRemoteUser();
  if (userString == null) {
    userString="";
  }
 else {
    userString+="@";
  }
  String bytesString="";
  if (response.getContentCount() > 0) {
    bytesString=" " + response.getContentCount() + " bytes";
  }
  if (logger.isLoggable(logStatus)) {
    TreeLogger branch=logger.branch(logStatus,String.valueOf(status) + " - " + request.getMethod()+ ' '+ request.getUri()+ " ("+ userString+ request.getRemoteHost()+ ')'+ bytesString);
    if (branch.isLoggable(logHeaders)) {
      TreeLogger headers=branch.branch(logHeaders,"Request headers");
      Iterator<Field> headerFields=request.getConnection().getRequestFields().getFields();
      while (headerFields.hasNext()) {
        Field headerField=headerFields.next();
        headers.log(logHeaders,headerField.getName() + ": " + headerField.getValue());
      }
      headers=branch.branch(logHeaders,"Response headers");
      headerFields=response.getHttpFields().getFields();
      while (headerFields.hasNext()) {
        Field headerField=headerFields.next();
        headers.log(logHeaders,headerField.getName() + ": " + headerField.getValue());
      }
    }
  }
}
