{
  int status=response.getStatus();
  if (status < 0) {
    status=404;
  }
  TreeLogger.Type logStatus, logHeaders;
  if (status >= 500) {
    logStatus=TreeLogger.ERROR;
    logHeaders=TreeLogger.INFO;
  }
 else   if (status == 404) {
    if ("/favicon.ico".equals(request.getRequestURI()) && request.getQueryString() == null) {
      logStatus=TreeLogger.TRACE;
      logHeaders=TreeLogger.DEBUG;
    }
 else {
      logStatus=TreeLogger.WARN;
      logHeaders=TreeLogger.INFO;
    }
  }
 else   if (status >= 400) {
    logStatus=TreeLogger.WARN;
    logHeaders=TreeLogger.INFO;
  }
 else {
    logStatus=normalLogLevel;
    logHeaders=TreeLogger.DEBUG;
  }
  String userString=request.getRemoteUser();
  if (userString == null) {
    userString="";
  }
 else {
    userString+="@";
  }
  String bytesString="";
  if (response.getContentCount() > 0) {
    bytesString=" " + response.getContentCount() + " bytes";
  }
  if (logger.isLoggable(logStatus)) {
    TreeLogger branch=logger.branch(logStatus,String.valueOf(status) + " - " + request.getMethod()+ ' '+ request.getUri()+ " ("+ userString+ request.getRemoteHost()+ ')'+ bytesString);
    if (branch.isLoggable(logHeaders)) {
      AbstractHttpConnection connection=request.getConnection();
      logHeaders(branch.branch(logHeaders,"Request headers"),logHeaders,connection.getRequestFields());
      logHeaders(branch.branch(logHeaders,"Response headers"),logHeaders,connection.getResponseFields());
    }
  }
}
