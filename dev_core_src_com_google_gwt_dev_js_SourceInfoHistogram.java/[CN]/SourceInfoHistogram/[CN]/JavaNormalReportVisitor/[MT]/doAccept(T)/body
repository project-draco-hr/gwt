{
  boolean openContext=node instanceof HasSourceInfo;
  SourceInfo sourceInfo=null;
  try {
    if (openContext) {
      sourceInfo=((HasSourceInfo)node).getSourceInfo();
      if (!stack.isEmpty()) {
        int count=commit(stack.peek(),true);
        accumulateTotal(sourceInfo,count);
      }
      stack.push((HasSourceInfo)node);
      out.begin();
    }
    return super.doAccept(node);
  }
  finally {
    if (openContext) {
      int count=commit((HasSourceInfo)node,false);
      accumulateTotal(sourceInfo,count);
      if (stack.pop() != node) {
        throw new RuntimeException("Unexpected node popped");
      }
    }
  }
}
