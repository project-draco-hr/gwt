{
  Map<String,CompilationUnit> resultUnits=new HashMap<String,CompilationUnit>();
  for (  GeneratedUnit generatedUnit : generatedUnits) {
    ContentId contentId=new ContentId(generatedUnit.getTypeName(),generatedUnit.getStrongHash());
    CompilationUnit existingUnit=unitCache.get(contentId);
    if (existingUnit != null && !existingUnit.isError()) {
      resultUnits.put(existingUnit.getTypeName(),existingUnit);
    }
  }
  CompilationUnitInvalidator.retainValidUnits(TreeLogger.NULL,resultUnits.values(),compileMoreLater.getValidDependencies());
  for (  CompilationUnit validUnit : resultUnits.values()) {
    compileMoreLater.addValidUnit(validUnit);
  }
  List<CompilationUnitBuilder> builders=new ArrayList<CompilationUnitBuilder>();
  for (  GeneratedUnit generatedUnit : generatedUnits) {
    if (!resultUnits.containsKey(generatedUnit.getTypeName())) {
      builders.add(new GeneratedCompilationUnitBuilder(generatedUnit));
    }
  }
  compileMoreLater.compile(builders,resultUnits);
  ArrayList<CompilationUnit> result=new ArrayList<CompilationUnit>(resultUnits.values());
  Collections.sort(result,CompilationUnit.COMPARATOR);
  TreeLogger branch=logger.branch(TreeLogger.DEBUG,"Validating newly compiled units");
  for (  CompilationUnit unit : result) {
    CompilationUnitInvalidator.reportErrors(branch,unit);
  }
  return result;
}
