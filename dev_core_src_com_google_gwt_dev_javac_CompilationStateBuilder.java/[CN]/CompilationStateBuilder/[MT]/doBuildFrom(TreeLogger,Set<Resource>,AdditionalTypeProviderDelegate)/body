{
  Event compilationStateBuilderProcess=SpeedTracerLogger.start(DevModeEventType.COMPILATION_STATE_BUILDER_PROCESS);
  try {
    Map<String,CompilationUnit> resultUnits=new HashMap<String,CompilationUnit>();
    for (    Resource resource : resources) {
      String location=resource.getLocation();
      ResourceTag tag=resourceContentCache.get(location);
      if (tag != null && tag.getLastModified() == resource.getLastModified()) {
        ContentId contentId=tag.getContentId();
        CompilationUnit existingUnit=unitCache.get(contentId);
        if (existingUnit != null && !existingUnit.isError()) {
          resultUnits.put(existingUnit.getTypeName(),existingUnit);
        }
      }
    }
    CompilationUnitInvalidator.retainValidUnits(TreeLogger.NULL,resultUnits.values());
    CompileMoreLater compileMoreLater=new CompileMoreLater(compilerDelegate);
    List<CompilationUnitBuilder> builders=new ArrayList<CompilationUnitBuilder>();
    for (    Resource resource : resources) {
      String typeName=Shared.toTypeName(resource.getPath());
      CompilationUnit validUnit=resultUnits.get(typeName);
      if (validUnit != null) {
        compileMoreLater.addValidUnit(validUnit);
      }
 else {
        builders.add(new ResourceCompilationUnitBuilder(typeName,resource));
      }
    }
    compileMoreLater.compile(builders,resultUnits);
    ArrayList<CompilationUnit> result=new ArrayList<CompilationUnit>(resultUnits.values());
    Collections.sort(result,CompilationUnit.COMPARATOR);
    TreeLogger branch=logger.branch(TreeLogger.DEBUG,"Validating newly compiled units");
    for (    CompilationUnit unit : result) {
      CompilationUnitInvalidator.reportErrors(branch,unit);
    }
    return new CompilationState(logger,result,compileMoreLater);
  }
  finally {
    compilationStateBuilderProcess.end();
  }
}
