{
  Event event=SpeedTracerLogger.start(DevModeEventType.CSB_PROCESS);
  try {
    Map<MethodDeclaration,JsniMethod> jsniMethods=JsniCollector.collectJsniMethods(cud,builder.getSource(),JsRootScope.INSTANCE,DummyCorrelationFactory.INSTANCE);
    JSORestrictionsChecker.check(jsoState,cud);
    final Set<String> jsniDeps=new HashSet<String>();
    Map<String,Binding> jsniRefs=new HashMap<String,Binding>();
    JsniChecker.check(cud,jsoState,jsniMethods,jsniRefs,new JsniChecker.TypeResolver(){
      public ReferenceBinding resolveType(      String typeName){
        ReferenceBinding resolveType=compiler.resolveType(typeName);
        if (resolveType != null) {
          jsniDeps.add(String.valueOf(resolveType.qualifiedSourceName()));
        }
        return resolveType;
      }
    }
);
    ArtificialRescueChecker.check(cud,builder.isGenerated());
    BinaryTypeReferenceRestrictionsChecker.check(cud);
    MethodArgNamesLookup methodArgs=MethodParamCollector.collect(cud);
    StringInterner interner=StringInterner.get();
    String packageName=interner.intern(Shared.getPackageName(builder.getTypeName()));
    List<String> unresolvedQualified=new ArrayList<String>();
    List<String> unresolvedSimple=new ArrayList<String>();
    for (    char[] simpleRef : cud.compilationResult().simpleNameReferences) {
      unresolvedSimple.add(interner.intern(String.valueOf(simpleRef)));
    }
    for (    char[][] qualifiedRef : cud.compilationResult().qualifiedReferences) {
      unresolvedQualified.add(interner.intern(CharOperation.toString(qualifiedRef)));
    }
    for (    String jsniDep : jsniDeps) {
      unresolvedQualified.add(interner.intern(jsniDep));
    }
    ArrayList<String> apiRefs=compiler.collectApiRefs(cud);
    for (int i=0; i < apiRefs.size(); ++i) {
      apiRefs.set(i,interner.intern(apiRefs.get(i)));
    }
    Dependencies dependencies=new Dependencies(packageName,unresolvedQualified,unresolvedSimple,apiRefs);
    List<JDeclaredType> types=Collections.emptyList();
    if (GwtAstBuilder.ENABLED) {
      if (!cud.compilationResult().hasErrors()) {
        types=astBuilder.process(cud,jsniMethods,jsniRefs);
      }
    }
    CompilationUnit unit=builder.build(compiledClasses,types,dependencies,jsniMethods.values(),methodArgs,cud.compilationResult().getProblems());
    addValidUnit(unit);
    ContentId contentId=builder.getContentId();
    unitCache.put(contentId,unit);
    if (builder instanceof ResourceCompilationUnitBuilder) {
      ResourceCompilationUnitBuilder rcub=(ResourceCompilationUnitBuilder)builder;
      ResourceTag resourceTag=new ResourceTag(rcub.getLastModifed(),contentId);
      resourceContentCache.put(builder.getLocation(),resourceTag);
      keepAliveLatestVersion.put(resourceTag,unit);
    }
 else     if (builder instanceof GeneratedCompilationUnitBuilder) {
      keepAliveRecentlyGenerated.put(unit.getTypeName(),unit);
    }
    newlyBuiltUnits.add(unit);
  }
  finally {
    event.end();
  }
}
