{
  TestSessionHandler handler=new TestSessionHandler();
  TestBrowserChannelServer server=new TestBrowserChannelServer(new FailErrorLogger(),clientToServer.getInputStream(),serverToClient.getOutputStream(),handler);
  TestBrowserChannel client=new TestBrowserChannel(serverToClient.getInputStream(),clientToServer.getOutputStream());
  new OldLoadModuleMessage(client,1,"testModule","userAgent").send();
  MessageType type=client.readMessageType();
  assertEquals("testModule",handler.getModuleName());
  assertEquals("userAgent",handler.getUserAgent());
  assertNull(handler.getUrl());
  assertNull(handler.getTabKey());
  assertNull(handler.getSessionKey());
  assertNull(handler.getUserAgentIcon());
  assertEquals(MessageType.RETURN,type);
  DevModeSession session=server.getDevModeSession();
  assertNotNull(session);
  assertEquals("testModule",session.getModuleName());
  assertEquals("userAgent",session.getUserAgent());
  ReturnMessage.receive(client);
  QuitMessage.send(client);
  server.waitForClose();
  assertNull(handler.getLoadedModule());
  server.notifier.verify("testModule","userAgent");
}
