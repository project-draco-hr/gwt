{
  if (tree == null) {
    return newNode;
  }
 else {
    int c=cmp.compare(newNode.getKey(),tree.getKey());
    if (c == 0) {
      state.value=tree.setValue(newNode.getValue());
      state.found=true;
      return tree;
    }
    int childNum=c < 0 ? LEFT : RIGHT;
    tree.child[childNum]=insert(tree.child[childNum],newNode,state);
    if (isRed(tree.child[childNum])) {
      if (isRed(tree.child[otherChild(childNum)])) {
        tree.isRed=true;
        tree.child[LEFT].isRed=false;
        tree.child[RIGHT].isRed=false;
      }
 else {
        if (isRed(tree.child[childNum].child[childNum])) {
          tree=rotateSingle(tree,otherChild(childNum));
        }
 else         if (isRed(tree.child[childNum].child[otherChild(childNum)])) {
          tree=rotateDouble(tree,otherChild(childNum));
        }
      }
    }
  }
  return tree;
}
