{
  if (prepared) {
    return;
  }
  URL[] resources=ResourceGeneratorUtil.findResources(logger,context,method);
  if (resources.length != 1) {
    logger.log(TreeLogger.ERROR,"Exactly one image may be specified",null);
    throw new UnableToCompleteException();
  }
  ImageBundleBuilder builder=getBuilder(method);
  URL resource=resources[0];
  String name=method.getName();
  ImageRect rect;
  try {
    rect=builder.assimilate(logger,name,resource);
    if (context.supportsDataUrls() || getRepeatStyle(method) == RepeatStyle.Both) {
      builder.removeMapping(name);
      rect.setPosition(0,0);
      throw new UnsuitableForStripException(rect);
    }
    shared.buildersByImageRect.put(rect,builder);
  }
 catch (  UnsuitableForStripException e) {
    URL normalContents;
    rect=e.getImageRect();
    if (rect.isAnimated() || rect.isLossy()) {
      normalContents=resource;
    }
 else {
      normalContents=reencodeToTempFile(logger,rect);
    }
    shared.urlsByExternalImageRect.put(rect,new URL[]{normalContents,null});
  }
  shared.imageRectsByName.put(name,rect);
  if (getFlipRtl(method)) {
    shared.rtlImages.add(rect);
  }
}
