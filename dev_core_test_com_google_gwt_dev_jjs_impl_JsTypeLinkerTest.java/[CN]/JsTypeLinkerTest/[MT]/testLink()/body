{
  NamedRange programRange=new NamedRange("Program");
  NamedRange someModelARange=new NamedRange("com.some.app.SomeAModel");
  NamedRange someModelBRange=new NamedRange("com.some.app.SomeBModel");
  NamedRange someControllerRange=new NamedRange("com.some.app.SomeController");
  NamedRange entryPointRange=new NamedRange("com.some.app.EntryPoint");
  List<NamedRange> classRanges=Lists.newArrayList(someModelARange,someModelBRange,someControllerRange,entryPointRange);
  StatementRangesBuilder srb=new StatementRangesBuilder();
  JsSourceMapBuilder smb=new JsSourceMapBuilder();
  StringBuilder sb=new StringBuilder();
  appendStatement(sb,srb,smb,"<preamble>\n");
  appendStatement(sb,srb,smb,"<java.lang.Object />\n");
  appendStatement(sb,srb,smb,"<java.lang.Class />\n");
  appendStatement(sb,srb,smb,"</preamble>\n");
{
    programRange.setStartPosition(sb.length());
    programRange.setStartLineNumber(lines);
    appendTypeStatement(sb,srb,smb,someModelARange,"<com.some.app.SomeModelA>\n");
    appendTypeStatement(sb,srb,smb,someModelBRange,"<com.some.app.SomeModelB>\n");
    appendTypeStatement(sb,srb,smb,someControllerRange,"<com.some.app.SomeController>\n");
    appendTypeStatement(sb,srb,smb,entryPointRange,"<com.some.app.EntryPoint>\n");
    programRange.setEndPosition(sb.length());
    programRange.setEndLineNumber(lines);
  }
  appendStatement(sb,srb,smb,"<epilogue>\n");
  appendStatement(sb,srb,smb,"<Some Bootstrap Code>\n");
  appendStatement(sb,srb,smb,"</epilogue>\n");
  String originalJs=sb.toString();
  MinimalRebuildCache minimalRebuildCache=new MinimalRebuildCache();
  Map<String,String> superClassesByClass=minimalRebuildCache.getImmediateTypeRelations().getImmediateSuperclassesByClass();
  StringAnalyzableTypeEnvironment typeEnvironment=minimalRebuildCache.getTypeEnvironment();
  typeEnvironment.recordTypeEnclosesMethod("java.lang.Object","java.lang.Object::$clinit()");
  superClassesByClass.put("java.lang.Class","java.lang.Object");
  typeEnvironment.recordTypeEnclosesMethod("java.lang.Class","java.lang.Class::$clinit()");
  superClassesByClass.put("com.some.app.SomeAModel","java.lang.Object");
  typeEnvironment.recordTypeEnclosesMethod("com.some.app.SomeAModel","com.some.app.SomeAModel::$clinit()");
  superClassesByClass.put("com.some.app.SomeBModel","java.lang.Object");
  typeEnvironment.recordTypeEnclosesMethod("com.some.app.SomeBModel","com.some.app.SomeBModel::$clinit()");
  superClassesByClass.put("com.some.app.SomeController","java.lang.Object");
  typeEnvironment.recordTypeEnclosesMethod("com.some.app.SomeController","com.some.app.SomeController::$clinit()");
  superClassesByClass.put("com.some.app.EntryPoint","java.lang.Object");
  typeEnvironment.recordTypeEnclosesMethod("com.some.app.EntryPoint","com.some.app.EntryPoint::$clinit()");
  minimalRebuildCache.setRootTypeNames(Lists.newArrayList("com.some.app.EntryPoint"));
  minimalRebuildCache.setEntryMethodNames(Lists.newArrayList("com.some.app.EntryPoint::onModuleLoad()"));
  typeEnvironment.recordTypeEnclosesMethod("com.some.app.EntryPoint","com.some.app.EntryPoint::onModuleLoad()");
  minimalRebuildCache.addTypeReference("com.some.app.EntryPoint","com.some.app.SomeController");
  typeEnvironment.recordMethodInstantiatesType("com.some.app.EntryPoint::onModuleLoad()","com.some.app.SomeController");
  typeEnvironment.recordMethodCallsMethod("com.some.app.EntryPoint::onModuleLoad()","com.some.app.SomeController::createData()");
  typeEnvironment.recordTypeEnclosesMethod("com.some.app.SomeController","com.some.app.SomeController::createData()");
  minimalRebuildCache.addTypeReference("com.some.app.SomeController","com.some.app.SomeBModel");
  typeEnvironment.recordMethodInstantiatesType("com.some.app.SomeController::createData()","com.some.app.SomeBModel");
  typeEnvironment.recordMethodCallsMethod("com.some.app.SomeController::createData()","com.some.app.SomeBModel::SomeBModel()");
  typeEnvironment.recordTypeEnclosesMethod("com.some.app.SomeBModel","com.some.app.SomeBModel::SomeBModel()");
  minimalRebuildCache.addTypeReference("com.some.app.SomeController","com.some.app.SomeAModel");
  typeEnvironment.recordMethodInstantiatesType("com.some.app.SomeController::createData()","com.some.app.SomeAModel");
  typeEnvironment.recordMethodCallsMethod("com.some.app.SomeController::createData()","com.some.app.SomeAModel::SomeAModel()");
  typeEnvironment.recordTypeEnclosesMethod("com.some.app.SomeAModel","com.some.app.SomeAModel::SomeAModel()");
  JsTypeLinker jsTypeLinker=new JsTypeLinker(TreeLogger.NULL,new JsNoopTransformer(originalJs,srb.build(),smb.build()),classRanges,programRange,minimalRebuildCache,new JTypeOracle(null,minimalRebuildCache,true));
  jsTypeLinker.exec();
  assertEquals("<preamble>\n<java.lang.Object />\n<java.lang.Class />\n</preamble>\n" + "<com.some.app.EntryPoint>\n" + "<com.some.app.SomeModelA>\n"+ "<com.some.app.SomeModelB>\n"+ "<com.some.app.SomeController>\n"+ "<epilogue>\n<Some Bootstrap Code>\n</epilogue>\n",jsTypeLinker.getJs());
  assertEquals(Lists.newArrayList("preamble","java.lang.Object","java.lang.Class","/preamble","com.some.app.EntryPoint","com.some.app.SomeModelA","com.some.app.SomeModelB","com.some.app.SomeController","epilogue","Some Bootstrap Code","/epilogue"),getTypeNames(jsTypeLinker.getSourceInfoMap()));
  assertEquals(11,jsTypeLinker.getSourceInfoMap().getLines());
  superClassesByClass.put("com.some.app.SomeAModel","com.some.app.SomeBModel");
  jsTypeLinker=new JsTypeLinker(TreeLogger.NULL,new JsNoopTransformer(originalJs,srb.build(),smb.build()),classRanges,programRange,minimalRebuildCache,new JTypeOracle(null,minimalRebuildCache,true));
  jsTypeLinker.exec();
  assertEquals("<preamble>\n<java.lang.Object />\n<java.lang.Class />\n</preamble>\n" + "<com.some.app.EntryPoint>\n" + "<com.some.app.SomeModelB>\n"+ "<com.some.app.SomeModelA>\n"+ "<com.some.app.SomeController>\n"+ "<epilogue>\n<Some Bootstrap Code>\n</epilogue>\n",jsTypeLinker.getJs());
  assertEquals(Lists.newArrayList("preamble","java.lang.Object","java.lang.Class","/preamble","com.some.app.EntryPoint","com.some.app.SomeModelB","com.some.app.SomeModelA","com.some.app.SomeController","epilogue","Some Bootstrap Code","/epilogue"),getTypeNames(jsTypeLinker.getSourceInfoMap()));
  assertEquals(11,jsTypeLinker.getSourceInfoMap().getLines());
  minimalRebuildCache.removeReferencesFrom("com.some.app.SomeController");
  minimalRebuildCache.addTypeReference("com.some.app.SomeController","com.some.app.SomeBModel");
  typeEnvironment.removeControlFlowIndexesFor("com.some.app.SomeController");
  typeEnvironment.recordTypeEnclosesMethod("com.some.app.SomeController","com.some.app.SomeController::createData()");
  typeEnvironment.recordTypeEnclosesMethod("com.some.app.SomeController","com.some.app.SomeController::$clinit()");
  typeEnvironment.recordMethodInstantiatesType("com.some.app.SomeController::createData()","com.some.app.SomeBModel");
  typeEnvironment.recordMethodCallsMethod("com.some.app.SomeController::createData()","com.some.app.SomeBModel::SomeBModel()");
  jsTypeLinker=new JsTypeLinker(TreeLogger.NULL,new JsNoopTransformer(originalJs,srb.build(),smb.build()),classRanges,programRange,minimalRebuildCache,new JTypeOracle(null,minimalRebuildCache,true));
  jsTypeLinker.exec();
  assertEquals("<preamble>\n<java.lang.Object />\n<java.lang.Class />\n</preamble>\n" + "<com.some.app.EntryPoint>\n" + "<com.some.app.SomeModelB>\n"+ "<com.some.app.SomeController>\n"+ "<epilogue>\n<Some Bootstrap Code>\n</epilogue>\n",jsTypeLinker.getJs());
  assertEquals(Lists.newArrayList("preamble","java.lang.Object","java.lang.Class","/preamble","com.some.app.EntryPoint","com.some.app.SomeModelB","com.some.app.SomeController","epilogue","Some Bootstrap Code","/epilogue"),getTypeNames(jsTypeLinker.getSourceInfoMap()));
  assertEquals(10,jsTypeLinker.getSourceInfoMap().getLines());
}
