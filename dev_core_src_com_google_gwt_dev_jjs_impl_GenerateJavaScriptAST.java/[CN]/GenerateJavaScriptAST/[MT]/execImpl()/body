{
  new FixNameClashesVisitor().accept(program);
  uninitializedValuePotentiallyObservable=optimize ? ComputePotentiallyObservableUninitializedValues.analyze(program) : Predicates.<JField>alwaysTrue();
  new FindNameOfTargets().accept(program);
  new SortVisitor().accept(program);
  if (!incremental) {
    new RecordCrossClassCallsAndConstructorLiveness().accept(program);
  }
  contructTypeToClassLiteralDeclarationMap();
  CreateNamesAndScopesVisitor creator=new CreateNamesAndScopesVisitor();
  creator.accept(program);
  GenerateJavaScriptVisitor generator=new GenerateJavaScriptVisitor();
  generator.accept(program);
  jsProgram.setIndexedFields(indexedFields);
  jsProgram.setIndexedFunctions(indexedFunctions);
  JavaToJavaScriptMap jjsMap=new JavaToJavaScriptMapImpl(program.getDeclaredTypes(),names,typeForStatMap,vtableInitForMethodMap);
  Set<JsNode> functionsForJsInlining=incremental ? Collections.<JsNode>emptySet() : new CollectJsFunctionsForInlining().getFunctionsForJsInlining();
  return Pair.create(jjsMap,functionsForJsInlining);
}
