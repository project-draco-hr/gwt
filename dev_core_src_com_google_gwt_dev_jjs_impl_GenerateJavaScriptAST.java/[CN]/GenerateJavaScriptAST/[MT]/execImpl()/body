{
  new FixNameClashesVisitor().accept(program);
  CanObserveSubclassUninitializedFieldsVisitor canObserve=new CanObserveSubclassUninitializedFieldsVisitor();
  canObserve.accept(program);
  SortVisitor sorter=new SortVisitor();
  sorter.accept(program);
  RecordCrossClassCallsAndJSInlinableMethods recorder=new RecordCrossClassCallsAndJSInlinableMethods();
  recorder.accept(program);
  CreateNamesAndScopesVisitor creator=new CreateNamesAndScopesVisitor();
  creator.accept(program);
  GenerateJavaScriptVisitor generator=new GenerateJavaScriptVisitor(recorder.methodsForJsInlining);
  generator.accept(program);
  jsProgram.setIndexedFields(indexedFields);
  jsProgram.setIndexedFunctions(indexedFunctions);
  JavaToJavaScriptMap jjsMap=new JavaToJavaScriptMapImpl(program.getDeclaredTypes(),names,typeForStatMap,vtableInitForMethodMap);
  return Pair.create(jjsMap,generator.functionsForJsInlining);
}
