{
  PerfLogger.start("CompilationState.compile");
  if (jdtCompiler.doCompile(newUnits)) {
    logger=logger.branch(TreeLogger.DEBUG,"Validating newly compiled units");
    boolean anyErrors=CompilationUnitInvalidator.invalidateUnitsWithErrors(logger,newUnits);
    CompilationUnitInvalidator.validateCompilationUnits(invalidatorState,newUnits,jdtCompiler.getBinaryTypeNames());
    anyErrors|=CompilationUnitInvalidator.invalidateUnitsWithErrors(logger,newUnits);
    if (anyErrors) {
      CompilationUnitInvalidator.invalidateUnitsWithInvalidRefs(logger,newUnits);
    }
    JsniCollector.collectJsniMethods(logger,newUnits,new JsProgram());
  }
  PerfLogger.end();
}
