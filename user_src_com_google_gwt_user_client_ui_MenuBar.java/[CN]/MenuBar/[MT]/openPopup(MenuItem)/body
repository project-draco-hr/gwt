{
  if (parentMenu != null && parentMenu.popup != null) {
    parentMenu.popup.setPreviewingAllNativeEvents(false);
  }
  popup=new DecoratedPopupPanel(true,false,"menuPopup"){
{
      setWidget(item.getSubMenu());
      setPreviewingAllNativeEvents(true);
      item.getSubMenu().onShow();
    }
    @Override protected void onPreviewNativeEvent(    NativePreviewEvent event){
      if (!event.isCanceled()) {
switch (event.getTypeInt()) {
case Event.ONMOUSEDOWN:
          EventTarget target=event.getNativeEvent().getEventTarget();
        Element parentMenuElement=item.getParentMenu().getElement();
      if (parentMenuElement.isOrHasChild(Element.as(target))) {
        event.cancel();
        return;
      }
    super.onPreviewNativeEvent(event);
  if (event.isCanceled()) {
    selectItem(null);
  }
return;
}
}
super.onPreviewNativeEvent(event);
}
}
;
popup.setAnimationType(AnimationType.ONE_WAY_CORNER);
popup.setAnimationEnabled(isAnimationEnabled);
popup.setStyleName(STYLENAME_DEFAULT + "Popup");
String primaryStyleName=getStylePrimaryName();
if (!STYLENAME_DEFAULT.equals(primaryStyleName)) {
popup.addStyleName(primaryStyleName + "Popup");
}
popup.addPopupListener(this);
shownChildMenu=item.getSubMenu();
item.getSubMenu().parentMenu=this;
popup.setPopupPositionAndShow(new PopupPanel.PositionCallback(){
@Override public void setPosition(int offsetWidth,int offsetHeight){
if (LocaleInfo.getCurrentLocale().isRTL()) {
if (vertical) {
popup.setPopupPosition(MenuBar.this.getAbsoluteLeft() - offsetWidth + 1,item.getAbsoluteTop());
}
 else {
popup.setPopupPosition(item.getAbsoluteLeft() + item.getOffsetWidth() - offsetWidth,MenuBar.this.getAbsoluteTop() + MenuBar.this.getOffsetHeight() - 1);
}
}
 else {
if (vertical) {
popup.setPopupPosition(MenuBar.this.getAbsoluteLeft() + MenuBar.this.getOffsetWidth() - 1,item.getAbsoluteTop());
}
 else {
popup.setPopupPosition(item.getAbsoluteLeft(),MenuBar.this.getAbsoluteTop() + MenuBar.this.getOffsetHeight() - 1);
}
}
}
}
);
}
