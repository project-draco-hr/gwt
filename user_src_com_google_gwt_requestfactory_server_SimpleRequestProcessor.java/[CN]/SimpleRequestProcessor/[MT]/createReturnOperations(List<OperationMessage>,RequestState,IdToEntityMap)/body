{
  for (  Map.Entry<SimpleProxyId<?>,AutoBean<? extends BaseProxy>> entry : toProcess.entrySet()) {
    SimpleProxyId<?> id=entry.getKey();
    AutoBean<? extends BaseProxy> bean=entry.getValue();
    Object domainObject=bean.getTag(Constants.DOMAIN_OBJECT);
    WriteOperation writeOperation;
    if (id.isEphemeral()) {
      returnState.getResolver().resolveClientValue(domainObject,id.getProxyClass(),Collections.<String>emptySet());
    }
    int version;
    if (id.isEphemeral() || id.isSynthetic()) {
      writeOperation=null;
      version=0;
    }
 else     if (service.loadDomainObject(returnState,service.getDomainClass(id.getProxyClass()),id.getServerId()) == null) {
      writeOperation=WriteOperation.DELETE;
      version=0;
    }
 else     if (id.wasEphemeral()) {
      writeOperation=WriteOperation.PERSIST;
      version=service.getVersion(domainObject);
    }
 else {
      writeOperation=WriteOperation.UPDATE;
      version=service.getVersion(domainObject);
    }
    boolean inResponse=bean.getTag(Constants.IN_RESPONSE) != null;
    if (WriteOperation.UPDATE.equals(writeOperation) && !inResponse) {
      if (Integer.valueOf(version).equals(bean.getTag(Constants.ENCODED_VERSION_PROPERTY))) {
        continue;
      }
    }
    OperationMessage op=FACTORY.operation().as();
    if (id.wasEphemeral()) {
      op.setClientId(id.getClientId());
    }
    op.setOperation(writeOperation);
    if (inResponse) {
      Map<String,Splittable> propertyMap=new LinkedHashMap<String,Splittable>();
      Map<String,Object> diff=AutoBeanUtils.getAllProperties(bean);
      for (      Map.Entry<String,Object> d : diff.entrySet()) {
        Object value=d.getValue();
        if (value != null) {
          propertyMap.put(d.getKey(),EntityCodex.encode(returnState,value));
        }
      }
      op.setPropertyMap(propertyMap);
    }
    if (!id.isEphemeral() && !id.isSynthetic()) {
      op.setServerId(toBase64(id.getServerId()));
    }
    op.setSyntheticId(id.getSyntheticId());
    op.setTypeToken(service.getTypeToken(id.getProxyClass()));
    op.setVersion(version);
    operations.add(op);
  }
}
