{
  if (entityInstance == null) {
    return null;
  }
  JSONObject jsonObject=new JSONObject();
  jsonObject.put(Constants.ENCODED_ID_PROPERTY,entityKey.encodedId);
  for (  Property<?> p : allProperties(entityKey.proxyType)) {
    String propertyName=p.getName();
    String methodName=getMethodNameFromPropertyName(propertyName,"get");
    Method method=entityInstance.getClass().getMethod(methodName);
    Object returnValue=method.invoke(entityInstance);
    Object propertyValue;
    String encodedEntityId=isEntityReference(returnValue,p.getType());
    if (returnValue == null) {
      propertyValue=JSONObject.NULL;
    }
 else     if (encodedEntityId != null) {
      propertyValue=encodedEntityId + "@NO@" + operationRegistry.getSecurityProvider().encodeClassType(p.getType());
    }
 else     if (p instanceof CollectionProperty<?,?>) {
      JSONArray array=new JSONArray();
      for (      Object val : ((Collection<?>)returnValue)) {
        String encodedIdVal=isEntityReference(val,p.getType());
        if (encodedIdVal != null) {
          propertyValue=encodedIdVal + "@NO@" + operationRegistry.getSecurityProvider().encodeClassType(p.getType());
        }
 else {
          propertyValue=encodePropertyValue(val);
        }
        array.put(propertyValue);
      }
      propertyValue=array;
    }
 else {
      propertyValue=encodePropertyValue(returnValue);
    }
    jsonObject.put(propertyName,propertyValue);
  }
  return jsonObject;
}
