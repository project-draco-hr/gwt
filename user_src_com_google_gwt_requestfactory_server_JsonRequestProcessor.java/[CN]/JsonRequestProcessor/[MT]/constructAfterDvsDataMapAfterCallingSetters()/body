{
  afterDvsDataMap=new HashMap<EntityKey,EntityData>();
  Set<EntityKey> done=new HashSet<EntityKey>();
  Set<EntityKey> queue=new HashSet<EntityKey>(involvedKeys);
  while (!queue.isEmpty()) {
    for (    EntityKey entityKey : queue) {
      DvsData dvsData=dvsDataMap.get(entityKey);
      if (dvsData != null) {
        EntityData entityData=getEntityDataForRecordWithSettersApplied(entityKey,dvsData.jsonObject,dvsData.writeOperation);
        if (entityKey.isFuture) {
        }
        afterDvsDataMap.put(entityKey,entityData);
      }
 else       if (entityKey.isFuture) {
        throw new RuntimeException("Future object with no dvsData");
      }
 else {
        SerializedEntity serializedEntity=beforeDataMap.get(entityKey);
        Object entityInstance=(serializedEntity == null) ? getEntityInstance(entityKey) : serializedEntity.entityInstance;
        if (entityInstance != null) {
          afterDvsDataMap.put(entityKey,new EntityData(entityInstance,null));
        }
      }
    }
    done.addAll(queue);
    queue.addAll(involvedKeys);
    queue.removeAll(done);
  }
}
