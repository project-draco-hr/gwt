{
  rebuildCompilationState();
  List<CompilationUnit> compilationUnits=Lists.newArrayList(state.getCompilationUnitMap().values());
  assertTrue(compilationUnits.size() > 10);
  File tmpDir=Utility.makeTemporaryDirectory(null,"cgmt-");
  int numLoops=100;
  String lastStrongName=null;
  for (int i=0; i < numLoops; i++) {
    File tmpFile=new File(tmpDir,"module" + i + ".ser");
    tmpFile.deleteOnExit();
    Collections.shuffle(compilationUnits);
    CompilationUnitArchive archive=new CompilationUnitArchive("com.example.Module");
    for (    CompilationUnit compilationUnit : compilationUnits) {
      archive.addUnit(compilationUnit);
    }
    archive.writeToFile(tmpFile);
    byte[] bytes=Util.readFileAsBytes(tmpFile);
    tmpFile.delete();
    String thisStrongName=Util.computeStrongName(bytes);
    if (lastStrongName != null) {
      assertEquals("loop " + i,thisStrongName,lastStrongName);
    }
    lastStrongName=thisStrongName;
  }
  tmpDir.delete();
}
