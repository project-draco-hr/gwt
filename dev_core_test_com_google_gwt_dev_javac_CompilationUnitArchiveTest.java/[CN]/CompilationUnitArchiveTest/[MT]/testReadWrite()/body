{
  rebuildCompilationState();
  List<CompilationUnit> compilationUnits=Lists.newArrayList(state.getCompilationUnitMap().values());
  CompilationUnitArchive archive1=new CompilationUnitArchive("com.example.Foo");
  for (  CompilationUnit compilationUnit : compilationUnits) {
    archive1.addUnit(compilationUnit);
  }
  assertEquals(compilationUnits.size(),archive1.getUnits().size());
  for (  CompilationUnit compilationUnit : compilationUnits) {
    compareUnits(compilationUnit,archive1,compilationUnit.getTypeName());
  }
  File tmp=File.createTempFile("cu-archive-test",".ser");
  tmp.deleteOnExit();
  archive1.writeToFile(tmp);
  CompilationUnitArchive archive2=CompilationUnitArchive.createFromFile(tmp);
  assertEquals(archive1.getUnits().size(),archive2.getUnits().size());
  for (  CompilationUnit compilationUnit : archive1.getUnits().values()) {
    compareUnits(compilationUnit,archive2,compilationUnit.getTypeName());
  }
}
