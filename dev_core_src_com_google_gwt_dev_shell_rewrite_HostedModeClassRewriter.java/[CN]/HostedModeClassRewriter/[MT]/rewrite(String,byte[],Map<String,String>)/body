{
  classBytes=maybeUpgradeBytecode(classBytes);
  String desc=BinaryName.toInternalName(className);
  ClassWriter writer=new ClassWriter(0);
  ClassVisitor v=writer;
  v=new WriteSingleJsoSupportCode(v,rewriterOracle);
  v=new RewriteJsoCasts(v,rewriterOracle);
  v=new RewriteJsoArrays(v,rewriterOracle);
  v=new RewriteObjectComparisons(v,rewriterOracle);
  if (rewriterOracle.isJsoOrSubtype(desc)) {
    v=WriteJsoImpl.create(v,desc);
  }
  v=new RewriteJsniMethods(v,anonymousClassMap);
  if (SYSTEM_CLASS_VERSION < Opcodes.V1_6) {
    v=new ForceClassVersion15(v);
  }
  new ClassReader(classBytes).accept(v,ClassReader.EXPAND_FRAMES);
  return writer.toByteArray();
}
