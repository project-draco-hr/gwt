{
  int fragments=program.getFragmentCount();
  JSModule[] modules=new JSModule[fragments];
  for (int i=0; i < fragments; i++) {
    modules[mapFragmentIndexToModuleIndex(i)]=createClosureModule(program,program.getFragment(i),"module" + i);
  }
  if (fragments > 1) {
    for (int i=1; i < loadModulesCount; i++) {
      modules[i].addDependency(modules[i - 1]);
    }
    JSModule leftovers=modules[loadModulesCount - 1];
    for (int i=loadModulesCount; i < modules.length; i++) {
      Preconditions.checkNotNull(modules[i],"Module: ",i);
      modules[i].addDependency(leftovers);
    }
  }
  modules[0].add(SourceFile.fromCode("hack","window['gwtOnLoad'] = gwtOnLoad;\n"));
  return Arrays.asList(modules);
}
