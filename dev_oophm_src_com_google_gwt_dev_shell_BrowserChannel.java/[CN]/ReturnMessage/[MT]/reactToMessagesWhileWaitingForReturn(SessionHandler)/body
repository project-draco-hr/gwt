{
  do {
    getStreamToOtherSide().flush();
    MessageType messageType=Message.readMessageType(getStreamFromOtherSide());
switch (messageType) {
case FreeValue:
      final FreeMessage freeMsg=FreeMessage.receive(this);
    handler.freeValue(this,freeMsg.getIds());
  break;
case Return:
return ReturnMessage.receive(this);
case Invoke:
final InvokeMessage imsg=InvokeMessage.receive(this);
ReturnMessage.send(this,handler.invoke(this,imsg.getThis(),imsg.getMethodDispatchId(),imsg.getArgs()));
break;
case InvokeSpecial:
handleInvokeSpecial(handler);
break;
default :
throw new BrowserChannelException("Invalid message type " + messageType + " received waiting for return.");
}
}
 while (true);
}
