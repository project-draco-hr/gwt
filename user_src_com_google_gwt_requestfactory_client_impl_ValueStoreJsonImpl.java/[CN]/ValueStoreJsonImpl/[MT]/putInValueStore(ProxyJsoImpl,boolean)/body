{
  RequestFactoryJsonImpl factory=newJsoRecord.getRequestFactory();
  EntityProxyIdImpl<?> recordKey=new EntityProxyIdImpl<EntityProxy>(newJsoRecord.encodedId(),newJsoRecord.getSchema(),isFuture,factory.datastoreToFutureMap.get(newJsoRecord.encodedId(),newJsoRecord.getSchema()));
  ProxyJsoImpl oldRecord=records.get(recordKey);
  if (oldRecord == null) {
    records.put(recordKey,newJsoRecord);
    newJsoRecord.assertValid();
    if (!isFuture) {
      factory.postChangeEvent(newJsoRecord,WriteOperation.UPDATE);
    }
    return null;
  }
  if (oldRecord.hasChanged(newJsoRecord)) {
    records.put(recordKey,newJsoRecord);
    factory.postChangeEvent(newJsoRecord,WriteOperation.UPDATE);
    return null;
  }
  return oldRecord;
}
