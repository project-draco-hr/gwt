{
  EntityProxyIdImpl recordKey=new EntityProxyIdImpl(newJsoRecord.getId(),newJsoRecord.getSchema(),RequestFactoryJsonImpl.NOT_FUTURE,newJsoRecord.getRequestFactory().datastoreToFutureMap.get(newJsoRecord.getId(),newJsoRecord.getSchema()));
  ProxyJsoImpl oldRecord=records.get(recordKey);
  if (oldRecord == null) {
    records.put(recordKey,newJsoRecord);
  }
 else {
    boolean changed=oldRecord.merge(newJsoRecord);
    newJsoRecord=oldRecord.cast();
    if (array != null) {
      array.set(i,newJsoRecord);
    }
    if (changed) {
      newJsoRecord.getRequestFactory().postChangeEvent(newJsoRecord,WriteOperation.UPDATE);
    }
  }
}
