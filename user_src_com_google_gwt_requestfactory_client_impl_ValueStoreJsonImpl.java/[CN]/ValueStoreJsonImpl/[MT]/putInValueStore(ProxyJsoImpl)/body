{
  EntityProxyIdImpl recordKey=new EntityProxyIdImpl(newJsoRecord.encodedId(),newJsoRecord.getSchema(),RequestFactoryJsonImpl.NOT_FUTURE,newJsoRecord.getRequestFactory().datastoreToFutureMap.get(newJsoRecord.encodedId(),newJsoRecord.getSchema()));
  ProxyJsoImpl oldRecord=records.get(recordKey);
  if (oldRecord == null) {
    records.put(recordKey,newJsoRecord);
    newJsoRecord.assertValid();
    newJsoRecord.getRequestFactory().postChangeEvent(newJsoRecord,WriteOperation.ACQUIRE);
    return null;
  }
  if (oldRecord.hasChanged(newJsoRecord)) {
    records.put(recordKey,newJsoRecord);
    newJsoRecord.getRequestFactory().postChangeEvent(newJsoRecord,WriteOperation.UPDATE);
    return null;
  }
  return oldRecord;
}
