{
  popup=new DecoratedPopupPanel(true,false,"menuPopup"){
{
      setWidget(item.getSubMenu());
      item.getSubMenu().onShow();
    }
    @Override public boolean onEventPreview(    Event event){
switch (DOM.eventGetType(event)) {
case Event.ONMOUSEDOWN:
        Element target=DOM.eventGetTarget(event);
      Element parentMenuElement=item.getParentMenu().getElement();
    if (DOM.isOrHasChild(parentMenuElement,target)) {
      return false;
    }
  boolean cancel=super.onEventPreview(event);
if (cancel) {
  selectItem(null);
}
return cancel;
}
return super.onEventPreview(event);
}
}
;
popup.setAnimationType(AnimationType.ONE_WAY_CORNER);
popup.setAnimationEnabled(isAnimationEnabled);
popup.setStyleName(STYLENAME_DEFAULT + "Popup");
String primaryStyleName=getStylePrimaryName();
if (!STYLENAME_DEFAULT.equals(primaryStyleName)) {
popup.addStyleName(primaryStyleName + "Popup");
}
popup.addPopupListener(this);
shownChildMenu=item.getSubMenu();
item.getSubMenu().parentMenu=this;
popup.setPopupPositionAndShow(new PopupPanel.PositionCallback(){
public void setPosition(int offsetWidth,int offsetHeight){
if (LocaleInfo.getCurrentLocale().isRTL()) {
if (vertical) {
popup.setPopupPosition(MenuBar.this.getAbsoluteLeft() - offsetWidth + 1,item.getAbsoluteTop());
}
 else {
popup.setPopupPosition(item.getAbsoluteLeft() + item.getOffsetWidth() - offsetWidth,MenuBar.this.getAbsoluteTop() + MenuBar.this.getOffsetHeight() - 1);
}
}
 else {
if (vertical) {
popup.setPopupPosition(MenuBar.this.getAbsoluteLeft() + MenuBar.this.getOffsetWidth() - 1,item.getAbsoluteTop());
}
 else {
popup.setPopupPosition(item.getAbsoluteLeft(),MenuBar.this.getAbsoluteTop() + MenuBar.this.getOffsetHeight() - 1);
}
}
}
}
);
}
