{
  if (moduleType == ModuleType.FILESET) {
    addFileset(canonicalModuleName);
  }
  if (monolithic) {
    currentAttributeSource.push(AttributeSource.TARGET_LIBRARY);
    targetLibraryCanonicalModuleNames.add(canonicalModuleName);
    return;
  }
  Preconditions.checkArgument(!(currentAttributeSource.isEmpty() && moduleType == ModuleType.FILESET));
  if (currentAttributeSource.isEmpty() && moduleType == ModuleType.LIBRARY) {
    currentAttributeSource.push(AttributeSource.TARGET_LIBRARY);
    targetLibraryCanonicalModuleNames.add(canonicalModuleName);
    return;
  }
  if (currentAttributeSource.peek() == AttributeSource.TARGET_LIBRARY) {
    if (moduleType == ModuleType.FILESET) {
      currentAttributeSource.push(AttributeSource.TARGET_LIBRARY);
      targetLibraryCanonicalModuleNames.add(canonicalModuleName);
    }
 else {
      currentAttributeSource.push(AttributeSource.EXTERNAL_LIBRARY);
      addExternalLibraryCanonicalModuleName(canonicalModuleName);
    }
  }
 else   if (currentAttributeSource.peek() == AttributeSource.EXTERNAL_LIBRARY) {
    currentAttributeSource.push(AttributeSource.EXTERNAL_LIBRARY);
  }
}
