{
  long permStart=System.currentTimeMillis();
  try {
    if (JProgram.isTracingEnabled()) {
      System.out.println("------------------------------------------------------------");
      System.out.println("|                     (new permuation)                     |");
      System.out.println("------------------------------------------------------------");
    }
    AST ast=unifiedAst.getFreshAst();
    JProgram jprogram=ast.getJProgram();
    JsProgram jsProgram=ast.getJsProgram();
    JJSOptions options=unifiedAst.getOptions();
    Map<StandardSymbolData,JsName> symbolTable=new TreeMap<StandardSymbolData,JsName>(new SymbolData.ClassIdentComparator());
    ResolveRebinds.exec(jprogram,rebindAnswers);
    if (options.isDraftCompile()) {
      draftOptimize(jprogram);
    }
 else {
      optimize(options,jprogram);
    }
    LinkedHashSet<Integer> initialLoadSequence=new LinkedHashSet<Integer>();
    if (options.isAggressivelyOptimize() && options.isRunAsyncEnabled()) {
      initialLoadSequence=CodeSplitter.pickInitialLoadSequence(logger,jprogram);
    }
    LongCastNormalizer.exec(jprogram);
    JsoDevirtualizer.exec(jprogram);
    CatchBlockNormalizer.exec(jprogram);
    PostOptimizationCompoundAssignmentNormalizer.exec(jprogram);
    LongEmulationNormalizer.exec(jprogram);
    CastNormalizer.exec(jprogram,options.isCastCheckingDisabled());
    ArrayNormalizer.exec(jprogram);
    EqualityNormalizer.exec(jprogram);
    Pruner.exec(jprogram,false);
    jprogram.typeOracle.recomputeAfterOptimizations();
    JavaToJavaScriptMap map=GenerateJavaScriptAST.exec(jprogram,jsProgram,options.getOutput(),symbolTable);
    JsNormalizer.exec(jsProgram);
    JsSymbolResolver.exec(jsProgram);
    EvalFunctionsAtTopScope.exec(jsProgram);
    if (options.isAggressivelyOptimize()) {
      boolean didChange;
      do {
        if (Thread.interrupted()) {
          throw new InterruptedException();
        }
        didChange=false;
        didChange=JsStaticEval.exec(jsProgram) || didChange;
        didChange=JsInliner.exec(jsProgram) || didChange;
        didChange=JsUnusedFunctionRemover.exec(jsProgram) || didChange;
      }
 while (didChange);
    }
    final Map<JsName,String> stringLiteralMap;
switch (options.getOutput()) {
case OBFUSCATED:
      stringLiteralMap=JsStringInterner.exec(jsProgram);
    JsObfuscateNamer.exec(jsProgram);
  break;
case PRETTY:
stringLiteralMap=new HashMap<JsName,String>();
JsPrettyNamer.exec(jsProgram);
break;
case DETAILED:
stringLiteralMap=JsStringInterner.exec(jsProgram);
JsVerboseNamer.exec(jsProgram);
break;
default :
throw new InternalCompilerException("Unknown output mode");
}
JavaToJavaScriptMap postStringInterningMap=addStringLiteralMap(map,stringLiteralMap);
if (options.isAggressivelyOptimize() && options.isRunAsyncEnabled()) {
CodeSplitter.exec(logger,jprogram,jsProgram,postStringInterningMap,initialLoadSequence);
}
JsIEBlockSizeVisitor.exec(jsProgram);
JsBreakUpLargeVarStatements.exec(jsProgram,propertyOracles);
String[] js=new String[jsProgram.getFragmentCount()];
List<Map<Range,SourceInfo>> sourceInfoMaps=options.isSoycEnabled() ? new ArrayList<Map<Range,SourceInfo>>(jsProgram.getFragmentCount()) : null;
StatementRanges[] ranges=new StatementRanges[js.length];
for (int i=0; i < js.length; i++) {
DefaultTextOutput out=new DefaultTextOutput(options.getOutput().shouldMinimize());
JsSourceGenerationVisitor v;
if (sourceInfoMaps != null) {
v=new JsReportGenerationVisitor(out);
}
 else {
v=new JsSourceGenerationVisitor(out);
}
v.accept(jsProgram.getFragmentBlock(i));
js[i]=out.toString();
if (sourceInfoMaps != null) {
sourceInfoMaps.add(((JsReportGenerationVisitor)v).getSourceInfoMap());
}
ranges[i]=v.getStatementRanges();
}
PermutationResult toReturn=new PermutationResultImpl(js,makeSymbolMap(symbolTable),ranges);
if (sourceInfoMaps != null) {
long soycStart=System.currentTimeMillis();
System.out.println("Computing SOYC output");
symbolTable=null;
long start=System.currentTimeMillis();
ByteArrayOutputStream baos=new ByteArrayOutputStream();
StoryRecorder.recordStories(logger,baos,sourceInfoMaps,js);
SoycArtifact stories=new SoycArtifact("stories" + permutationId + ".xml.gz",baos.toByteArray());
js=null;
System.out.println("Record stories: " + (System.currentTimeMillis() - start) + " ms");
start=System.currentTimeMillis();
baos.reset();
DependencyRecorder.recordDependencies(logger,baos,jprogram);
SoycArtifact dependencies=new SoycArtifact("dependencies" + permutationId + ".xml.gz",baos.toByteArray());
System.out.println("Record dependencies: " + (System.currentTimeMillis() - start) + " ms");
start=System.currentTimeMillis();
baos.reset();
SplitPointRecorder.recordSplitPoints(jprogram,baos,logger);
SoycArtifact splitPoints=new SoycArtifact("splitPoints" + permutationId + ".xml.gz",baos.toByteArray());
System.out.println("Record split points: " + (System.currentTimeMillis() - start) + " ms");
toReturn.getArtifacts().add(new StandardCompilationAnalysis(dependencies,stories,splitPoints));
System.out.println("Completed SOYC phase in " + (System.currentTimeMillis() - soycStart) + " ms");
}
System.out.println("Permutation took " + (System.currentTimeMillis() - permStart) + " ms");
return toReturn;
}
 catch (Throwable e) {
throw logAndTranslateException(logger,e);
}
}
