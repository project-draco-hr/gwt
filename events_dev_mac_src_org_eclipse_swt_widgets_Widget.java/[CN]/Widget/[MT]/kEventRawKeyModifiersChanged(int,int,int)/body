{
  Display display=this.display;
  int[] modifiers=new int[1];
  OS.GetEventParameter(theEvent,OS.kEventParamKeyModifiers,OS.typeUInt32,null,modifiers.length * 4,null,modifiers);
  int lastModifiers=display.lastModifiers;
  int chord=OS.GetCurrentEventButtonState();
  int type=SWT.KeyUp;
  if ((modifiers[0] & OS.alphaLock) != 0 && (lastModifiers & OS.alphaLock) == 0)   type=SWT.KeyDown;
  if ((modifiers[0] & OS.shiftKey) != 0 && (lastModifiers & OS.shiftKey) == 0)   type=SWT.KeyDown;
  if ((modifiers[0] & OS.controlKey) != 0 && (lastModifiers & OS.controlKey) == 0)   type=SWT.KeyDown;
  if ((modifiers[0] & OS.cmdKey) != 0 && (lastModifiers & OS.cmdKey) == 0)   type=SWT.KeyDown;
  if ((modifiers[0] & OS.optionKey) != 0 && (lastModifiers & OS.optionKey) == 0)   type=SWT.KeyDown;
  if (type == SWT.KeyUp && (modifiers[0] & OS.alphaLock) == 0 && (lastModifiers & OS.alphaLock) != 0) {
    Event event=new Event();
    event.keyCode=SWT.CAPS_LOCK;
    setInputState(event,SWT.KeyDown,chord,modifiers[0]);
    sendKeyEvent(SWT.KeyDown,event);
  }
  Event event=new Event();
  setInputState(event,type,chord,modifiers[0]);
  if (event.keyCode == 0 && event.character == 0)   return OS.eventNotHandledErr;
  boolean result=sendKeyEvent(type,event);
  if (type == SWT.KeyDown && (modifiers[0] & OS.alphaLock) != 0 && (lastModifiers & OS.alphaLock) == 0) {
    event=new Event();
    event.keyCode=SWT.CAPS_LOCK;
    setInputState(event,SWT.KeyUp,chord,modifiers[0]);
    sendKeyEvent(SWT.KeyUp,event);
  }
  display.lastModifiers=modifiers[0];
  return result ? OS.eventNotHandledErr : OS.noErr;
}
