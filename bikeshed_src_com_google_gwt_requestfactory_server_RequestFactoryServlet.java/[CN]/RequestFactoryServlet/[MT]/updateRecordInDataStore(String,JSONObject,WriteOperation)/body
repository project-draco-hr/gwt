{
  try {
    Class<?> entity=tokenToEntityRecord.get(recordToken).entity;
    Class<? extends Record> record=tokenToEntityRecord.get(recordToken).record;
    Map<String,Class<?>> propertiesInRecord=getPropertiesFromRecord(record);
    validateKeys(recordObject,propertiesInRecord.keySet());
    updatePropertyTypes(propertiesInRecord,entity);
    Object entityInstance=getEntityInstance(writeOperation,entity,recordObject.get("id"),propertiesInRecord.get("id"));
    Set<ConstraintViolation<Object>> violations=null;
    if (writeOperation == WriteOperation.DELETE) {
      entity.getMethod("remove").invoke(entityInstance);
    }
 else {
      Iterator<?> keys=recordObject.keys();
      while (keys.hasNext()) {
        String key=(String)keys.next();
        Class<?> propertyType=propertiesInRecord.get(key);
        if (writeOperation == WriteOperation.CREATE && ("id".equals(key))) {
          Long id=generateIdForCreate(key);
          if (id != null) {
            entity.getMethod(getMethodNameFromPropertyName(key,"set"),propertyType).invoke(entityInstance,id);
          }
        }
 else {
          Object propertyValue=getPropertyValueFromRequest(recordObject,key,propertyType);
          propertyValue=getSwizzledObject(propertyValue,propertyType);
          entity.getMethod(getMethodNameFromPropertyName(key,"set"),propertyType).invoke(entityInstance,propertyValue);
        }
      }
      ValidatorFactory validatorFactory=Validation.buildDefaultValidatorFactory();
      Validator validator=validatorFactory.getValidator();
      violations=validator.validate(entityInstance);
      if (violations.isEmpty()) {
        entity.getMethod("persist").invoke(entityInstance);
      }
    }
    return getReturnRecord(writeOperation,entityInstance,recordObject,violations);
  }
 catch (  Exception ex) {
    return getReturnRecordForException(writeOperation,recordObject,ex);
  }
}
