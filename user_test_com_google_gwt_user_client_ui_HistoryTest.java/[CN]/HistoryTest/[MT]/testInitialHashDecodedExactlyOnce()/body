{
  String originalHash=getCurrentLocationHash();
  String testHash="%2525";
  String undecodedHistoryToken=testHash;
  String correctHistoryToken="%25";
  String doubleDecodedHistoryToken="%";
  setHash(testHash);
  try {
    assertEquals(testHash,getCurrentLocationHash());
    HistoryImpl history=GWT.create(HistoryImpl.class);
    assertTrue(history.init());
    String historyToken=History.getToken();
    assertFalse("Failed to decode the initial hash",undecodedHistoryToken.equals(historyToken));
    assertFalse("Doubly decoded the initial hash",doubleDecodedHistoryToken.equals(historyToken));
    assertEquals(correctHistoryToken,historyToken);
  }
  finally {
    setHash(originalHash);
  }
}
