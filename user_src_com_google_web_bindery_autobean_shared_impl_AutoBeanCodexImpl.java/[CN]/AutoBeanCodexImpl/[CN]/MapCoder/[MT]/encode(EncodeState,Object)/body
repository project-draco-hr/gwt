{
  if (value == null) {
    state.sb.append("null");
    return;
  }
  Map<?,?> map=(Map<?,?>)value;
  boolean isSimpleMap=keyDecoder instanceof ValueCoder;
  if (isSimpleMap) {
    boolean first=true;
    state.sb.append("{");
    for (    Map.Entry<?,?> entry : map.entrySet()) {
      Object mapKey=entry.getKey();
      if (mapKey == null) {
        continue;
      }
      Object mapValue=entry.getValue();
      if (first) {
        first=false;
      }
 else {
        state.sb.append(",");
      }
      keyDecoder.encode(state,mapKey);
      state.sb.append(":");
      if (mapValue == null) {
        state.sb.append("null");
      }
 else {
        valueDecoder.encode(state,mapValue);
      }
    }
    state.sb.append("}");
  }
 else {
    List<Object> keys=new ArrayList<Object>(map.size());
    List<Object> values=new ArrayList<Object>(map.size());
    for (    Map.Entry<?,?> entry : map.entrySet()) {
      keys.add(entry.getKey());
      values.add(entry.getValue());
    }
    state.sb.append("[");
    collectionCoder(List.class,keyDecoder).encode(state,keys);
    state.sb.append(",");
    collectionCoder(List.class,valueDecoder).encode(state,values);
    state.sb.append("]");
  }
}
