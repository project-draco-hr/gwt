{
  delayTestFinish(DELAY_TEST_FINISH);
  SimpleFooRequest c1=req.simpleFooRequest();
  SimpleFooProxy foo1=c1.create(SimpleFooProxy.class);
  SimpleBarRequest c2=c1.append(req.simpleBarRequest());
  SimpleFooRequest c3=c2.append(req.simpleFooRequest());
  assertNotSame(c1,c3);
  assertSame(foo1,c2.edit(foo1));
  assertSame(foo1,c3.edit(foo1));
  SimpleBarProxy foo2=c2.create(SimpleBarProxy.class);
  assertSame(foo2,c1.edit(foo2));
  assertSame(foo2,c3.edit(foo2));
  SimpleFooProxy foo3=c3.create(SimpleFooProxy.class);
  assertSame(foo3,c1.edit(foo3));
  assertSame(foo3,c2.edit(foo3));
  try {
    req.simpleValueContext().append(c3);
    fail("Should have thrown IllegalStateException");
  }
 catch (  IllegalStateException expected) {
  }
  try {
    c3.append(createFactory().simpleFooRequest());
    fail("Should have thrown IllegalStateException");
  }
 catch (  IllegalStateException expected) {
  }
  final boolean[] seen={false,false};
  c1.add(1,2).to(new Receiver<Integer>(){
    @Override public void onSuccess(    Integer response){
      seen[0]=true;
      assertEquals(3,response.intValue());
    }
  }
);
  c2.countSimpleBar().to(new Receiver<Long>(){
    @Override public void onSuccess(    Long response){
      seen[1]=true;
      assertEquals(2,response.longValue());
    }
  }
);
  c2.fire(new Receiver<Void>(){
    @Override public void onSuccess(    Void response){
      assertTrue(seen[0]);
      assertTrue(seen[1]);
      finishTestAndReset();
    }
  }
);
  try {
    c1.fire();
    fail("Should have thrown exception");
  }
 catch (  IllegalStateException expected) {
  }
  try {
    c3.fire();
    fail("Should have thrown exception");
  }
 catch (  IllegalStateException expected) {
  }
  try {
    c3.create(SimpleFooProxy.class);
    fail("Should have thrown exception");
  }
 catch (  IllegalStateException expected) {
  }
}
