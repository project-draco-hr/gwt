{
  checkLocked();
  locked=true;
  freezeEntities(true);
  String payload=makePayload();
  requestFactory.getRequestTransport().send(payload,new TransportReceiver(){
    public void onTransportFailure(    ServerFailure failure){
      fail(receiver,failure);
    }
    public void onTransportSuccess(    String payload){
      ResponseMessage response=AutoBeanCodex.decode(MessageFactoryHolder.FACTORY,ResponseMessage.class,payload).as();
      if (response.getGeneralFailure() != null) {
        ServerFailureMessage failure=response.getGeneralFailure();
        ServerFailure fail=new ServerFailure(failure.getMessage(),failure.getExceptionType(),failure.getStackTrace(),failure.isFatal());
        fail(receiver,fail);
        return;
      }
      if (response.getViolations() != null) {
        Set<Violation> errors=new HashSet<Violation>();
        for (        ViolationMessage message : response.getViolations()) {
          errors.add(new MyViolation(message));
        }
        violation(receiver,errors);
        return;
      }
      processReturnOperations(response);
      Set<Throwable> causes=null;
      for (int i=0, j=invocations.size(); i < j; i++) {
        try {
          if (response.getStatusCodes().get(i)) {
            invocations.get(i).onSuccess(response.getInvocationResults().get(i));
          }
 else {
            ServerFailureMessage failure=AutoBeanCodex.decode(MessageFactoryHolder.FACTORY,ServerFailureMessage.class,response.getInvocationResults().get(i)).as();
            invocations.get(i).onFail(new ServerFailure(failure.getMessage(),failure.getExceptionType(),failure.getStackTrace(),failure.isFatal()));
          }
        }
 catch (        Throwable t) {
          if (causes == null) {
            causes=new HashSet<Throwable>();
          }
          causes.add(t);
        }
      }
      if (receiver != null) {
        try {
          receiver.onSuccess(null);
        }
 catch (        Throwable t) {
          if (causes == null) {
            causes=new HashSet<Throwable>();
          }
          causes.add(t);
        }
      }
      editedProxies.clear();
      invocations.clear();
      returnedProxies.clear();
      if (causes != null) {
        throw new UmbrellaException(causes);
      }
    }
    /** 
 * Invoke the appropriate {@code onFailure} callbacks, possibly throwing
 * an {@link UmbrellaException} if one or more callbacks fails.
 */
    private void fail(    Receiver<Void> receiver,    ServerFailure failure){
      reuse();
      Set<Throwable> causes=null;
      for (      AbstractRequest<?> request : new ArrayList<AbstractRequest<?>>(invocations)) {
        try {
          request.onFail(failure);
        }
 catch (        Throwable t) {
          if (causes == null) {
            causes=new HashSet<Throwable>();
          }
          causes.add(t);
        }
      }
      if (receiver != null) {
        try {
          receiver.onFailure(failure);
        }
 catch (        Throwable t) {
          if (causes == null) {
            causes=new HashSet<Throwable>();
          }
          causes.add(t);
        }
      }
      if (causes != null) {
        throw new UmbrellaException(causes);
      }
    }
    /** 
 * Invoke the appropriate {@code onViolation} callbacks, possibly throwing
 * an {@link UmbrellaException} if one or more callbacks fails.
 */
    private void violation(    final Receiver<Void> receiver,    Set<Violation> errors){
      reuse();
      Set<Throwable> causes=null;
      for (      AbstractRequest<?> request : new ArrayList<AbstractRequest<?>>(invocations)) {
        try {
          request.onViolation(errors);
        }
 catch (        Throwable t) {
          if (causes == null) {
            causes=new HashSet<Throwable>();
          }
          causes.add(t);
        }
      }
      if (receiver != null) {
        try {
          receiver.onViolation(errors);
        }
 catch (        Throwable t) {
          if (causes == null) {
            causes=new HashSet<Throwable>();
          }
          causes.add(t);
        }
      }
      if (causes != null) {
        throw new UmbrellaException(causes);
      }
    }
  }
);
}
