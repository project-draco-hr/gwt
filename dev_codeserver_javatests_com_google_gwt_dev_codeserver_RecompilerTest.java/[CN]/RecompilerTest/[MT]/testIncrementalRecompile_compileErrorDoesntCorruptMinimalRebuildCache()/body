{
  PrintWriterTreeLogger logger=new PrintWriterTreeLogger();
  logger.setMaxDetail(TreeLogger.ERROR);
  File sourcePath=Files.createTempDir();
  Options options=new Options();
  options.parseArgs(new String[]{"-incremental","-src",sourcePath.getAbsolutePath(),"com.foo.SimpleModule"});
  List<MockResource> originalResources=Lists.newArrayList(simpleModuleResource,referencesBarEntryPointResource,barReferencesBazResource,bazReferencesFooResource,fooResource);
  writeResourcesTo(originalResources,sourcePath);
  File baseCacheDir=Files.createTempDir();
  UnitCache unitCache=UnitCacheSingleton.get(logger,null,baseCacheDir);
  MinimalRebuildCacheManager minimalRebuildCacheManager=new MinimalRebuildCacheManager(logger,baseCacheDir);
  Recompiler recompiler=new Recompiler(OutboxDir.create(Files.createTempDir(),logger),null,"com.foo.SimpleModule",options,unitCache,minimalRebuildCacheManager);
  Outbox outbox=new Outbox("Transactional Cache",recompiler,options,logger);
  OutboxTable outboxes=new OutboxTable();
  outboxes.addOutbox(outbox);
  JobRunner runner=new JobRunner(new JobEventTable(),minimalRebuildCacheManager);
  Result result=compileWithChanges(logger,runner,outbox,sourcePath,Lists.<MockResource>newArrayList());
  assertTrue(result.isOk());
  result=compileWithChanges(logger,runner,outbox,sourcePath,Lists.<MockResource>newArrayList(nonCompilableFooResource));
  assertFalse(result.isOk());
  result=compileWithChanges(logger,runner,outbox,sourcePath,Lists.<MockResource>newArrayList(referencesBarEntryPointResource));
  assertFalse(result.isOk());
}
