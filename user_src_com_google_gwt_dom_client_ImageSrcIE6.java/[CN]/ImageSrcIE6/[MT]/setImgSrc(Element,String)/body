{
  boolean isSameSource=getImgSrc(img).equals(src);
  if (srcImgMap == null) {
    srcImgMap=JavaScriptObject.createObject();
  }
  String oldSrc=getPendingSrc(img);
  if (oldSrc != null) {
    Element top=getTop(srcImgMap,oldSrc);
    if (top == null) {
      cleanupExpandos(img);
    }
 else     if (top.equals(img)) {
      if (isSameSource) {
        return;
      }
      removeTop(srcImgMap,top);
    }
 else     if (removeChild(top,img,isSameSource)) {
      if (isSameSource) {
        return;
      }
    }
 else {
      cleanupExpandos(img);
    }
  }
  Element top=getTop(srcImgMap,src);
  if (top == null) {
    addTop(srcImgMap,img,src);
  }
 else {
    addChild(top,img);
  }
}
