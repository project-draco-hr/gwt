{
  int base=type.hashCode();
  int count=getCount(base);
  boolean flattened=isFlattened(base);
  H handler=myHandler;
  if ((count == EXPECTED_HANDLERS) & flattened) {
    unflatten(base);
    flattened=false;
  }
  if (flattened) {
    setFlatHandler(base,count,handler);
  }
 else {
    setHandler(base,count,handler);
  }
  setCount(base,count + 1);
}
