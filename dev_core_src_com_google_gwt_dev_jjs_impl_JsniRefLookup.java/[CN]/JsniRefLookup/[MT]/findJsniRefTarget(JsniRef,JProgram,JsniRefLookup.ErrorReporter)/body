{
  String className=ref.className();
  JType type=null;
  if (!className.equals("null")) {
    type=program.getTypeFromJsniRef(className);
    if (type == null) {
      errorReporter.reportError("Unresolvable native reference to type '" + className + "'");
      return null;
    }
  }
  if (!ref.isMethod()) {
    String fieldName=ref.memberName();
    if (type == null) {
      if (fieldName.equals("nullField")) {
        return program.getNullField();
      }
    }
 else     if (fieldName.equals("class")) {
      JClassLiteral lit=program.getLiteralClass(type);
      return lit.getField();
    }
 else     if (type instanceof JPrimitiveType) {
      errorReporter.reportError("May not refer to fields on primitive types");
      return null;
    }
 else     if (type instanceof JArrayType) {
      errorReporter.reportError("May not refer to fields on array types");
      return null;
    }
 else {
      for (      JField field : ((JDeclaredType)type).getFields()) {
        if (field.getName().equals(fieldName)) {
          return field;
        }
      }
    }
    errorReporter.reportError("Unresolvable native reference to field '" + fieldName + "' in type '"+ className+ "'");
    return null;
  }
 else   if (type instanceof JPrimitiveType) {
    errorReporter.reportError("May not refer to methods on primitive types");
    return null;
  }
 else {
    TreeSet<String> almostMatches=new TreeSet<String>();
    String methodName=ref.memberName();
    String jsniSig=ref.memberSignature();
    if (type == null) {
      if (jsniSig.equals("nullMethod()")) {
        return program.getNullMethod();
      }
    }
 else {
      Queue<JDeclaredType> workList=new LinkedList<JDeclaredType>();
      workList.add((JDeclaredType)type);
      while (!workList.isEmpty()) {
        JDeclaredType cur=workList.poll();
        for (        JMethod method : cur.getMethods()) {
          if (method.getName().equals(methodName)) {
            String sig=JProgram.getJsniSig(method);
            if (sig.equals(jsniSig)) {
              return method;
            }
 else             if (sig.startsWith(jsniSig) && jsniSig.endsWith(")")) {
              return method;
            }
 else {
              almostMatches.add(sig);
            }
          }
        }
        if (cur.getSuperClass() != null) {
          workList.add(cur.getSuperClass());
        }
        workList.addAll(cur.getImplements());
      }
    }
    if (almostMatches.isEmpty()) {
      errorReporter.reportError("Unresolvable native reference to method '" + methodName + "' in type '"+ className+ "'");
      return null;
    }
 else {
      StringBuilder suggestList=new StringBuilder();
      String comma="";
      for (      String almost : almostMatches) {
        suggestList.append(comma + "'" + almost+ "'");
        comma=", ";
      }
      errorReporter.reportError("Unresolvable native reference to method '" + methodName + "' in type '"+ className+ "' (did you mean "+ suggestList.toString()+ "?)");
      return null;
    }
  }
}
