{
  long nextFlush=System.currentTimeMillis() + FLUSH_TIMER_MSECS;
  try {
    while (true) {
      Event event=threadEventQueue.poll(nextFlush - System.currentTimeMillis(),TimeUnit.MILLISECONDS);
      if (event == null) {
      }
 else       if (event == shutDownSentinel) {
        break;
      }
 else       if (event == flushSentinel) {
        writer.flush();
        flushLatch.countDown();
      }
 else {
        JsonObject json=event.toJson();
        json.write(writer);
        writer.write('\n');
      }
      if (System.currentTimeMillis() >= nextFlush) {
        writer.flush();
        nextFlush=System.currentTimeMillis() + FLUSH_TIMER_MSECS;
      }
    }
    if (outputFormat.equals(Format.HTML)) {
      writer.write("</div></body></html>\n");
    }
    writer.close();
  }
 catch (  InterruptedException ignored) {
  }
catch (  IOException e) {
    log.log(Level.SEVERE,"Unable to write to gwt.speedtracerlog '" + (fileName == null ? "" : fileName) + "'",e);
  }
 finally {
    shutDownLatch.countDown();
  }
}
