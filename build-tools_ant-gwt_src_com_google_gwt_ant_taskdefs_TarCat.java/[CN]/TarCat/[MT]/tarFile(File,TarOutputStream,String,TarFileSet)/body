{
  int index=includeTarWrappers.indexOf(tarFileSet);
  if (index < 0) {
    super.tarFile(file,tOut,vPath,tarFileSet);
    return;
  }
  IncludeTar includeTar=(IncludeTar)includeTars.get(index);
  TarInputStream tIn=null;
  try {
    tIn=new TarInputStream(includeTar.compression.decompress(file,new BufferedInputStream(new FileInputStream(file))));
    TarEntry te=null;
    while ((te=tIn.getNextEntry()) != null) {
      vPath=te.getName();
      if (vPath.length() <= 0) {
        continue;
      }
      if (te.isDirectory() && !vPath.endsWith("/")) {
        vPath+="/";
      }
      String prefix=tarFileSet.getPrefix();
      if (prefix.length() > 0 && !prefix.endsWith("/")) {
        prefix=prefix + "/";
      }
      vPath=prefix + vPath;
      te.setName(vPath);
      tOut.putNextEntry(te);
      if (te.getSize() > 0) {
        byte[] buffer=new byte[8 * 1024];
        while (true) {
          int count=tIn.read(buffer,0,buffer.length);
          if (count < 0) {
            break;
          }
          tOut.write(buffer,0,count);
        }
      }
      tOut.closeEntry();
    }
  }
 catch (  IOException ioe) {
    throw new BuildException("Error while expanding " + file.getPath(),ioe,getLocation());
  }
 finally {
    if (tIn != null) {
      try {
        tIn.close();
      }
 catch (      IOException e) {
      }
    }
  }
}
