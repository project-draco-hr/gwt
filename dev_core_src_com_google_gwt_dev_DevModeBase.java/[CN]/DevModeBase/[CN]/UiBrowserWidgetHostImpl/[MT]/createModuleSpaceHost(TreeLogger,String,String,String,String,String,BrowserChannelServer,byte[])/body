{
  if (sessionKey == null) {
    sessionKey=randomString();
  }
  TreeLogger logger=mainLogger;
  TreeLogger.Type maxLevel=options.getLogLevel();
  String agentTag=BrowserInfo.getShortName(userAgent);
  String remoteSocket=serverChannel.getRemoteEndpoint();
  ModuleHandle module=ui.loadModule(userAgent,remoteSocket,url,tabKey,moduleName,sessionKey,agentTag,userAgentIcon,maxLevel);
  logger=module.getLogger();
  try {
    ModuleDef moduleDef=loadModule(logger,moduleName,true);
    assert(moduleDef != null);
    TypeOracle typeOracle=moduleDef.getTypeOracle(logger);
    ShellModuleSpaceHost host=doCreateShellModuleSpaceHost(logger,typeOracle,moduleDef);
    loadedModules.put(host,module);
    return host;
  }
 catch (  RuntimeException e) {
    logger.log(TreeLogger.ERROR,"Exception initializing module",e);
    ui.unloadModule(module);
    throw e;
  }
}
