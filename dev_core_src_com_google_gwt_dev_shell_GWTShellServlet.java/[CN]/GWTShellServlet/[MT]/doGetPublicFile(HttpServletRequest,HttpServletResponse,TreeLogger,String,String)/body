{
  String msg="The development shell servlet received a request for '" + partialPath + "' in module '"+ moduleName+ "' ";
  logger=logger.branch(TreeLogger.TRACE,msg,null);
  if (partialPath.equals(moduleName + ".nocache.html")) {
    if (request.getParameterMap().containsKey(HOSTED_MODE_QUERY_PARAM)) {
      try {
        String html=genSelectionPage(logger,moduleName);
        response.setContentType("text/html");
        response.getWriter().println(html);
        return;
      }
 catch (      UnableToCompleteException e) {
      }
    }
  }
  URL foundResource;
  try {
    ModuleDef moduleDef=getModuleDef(logger,moduleName);
    foundResource=moduleDef.findPublicFile(partialPath);
    if (foundResource == null) {
      File moduleDir=new File(getOutputDir(),moduleName);
      File requestedFile=new File(moduleDir,partialPath);
      if (requestedFile.exists()) {
        try {
          foundResource=requestedFile.toURL();
        }
 catch (        MalformedURLException e) {
        }
      }
      if (foundResource == null) {
        msg="Resource not found: " + partialPath;
        logger.log(TreeLogger.WARN,msg,null);
        throw new UnableToCompleteException();
      }
    }
  }
 catch (  UnableToCompleteException e) {
    sendErrorResponse(response,HttpServletResponse.SC_NOT_FOUND,"Cannot find resource '" + partialPath + "' in the public path of module '"+ moduleName+ "'");
    return;
  }
  String path=foundResource.toExternalForm();
  String mimeType=null;
  try {
    mimeType=getServletContext().getMimeType(path);
  }
 catch (  UnsupportedOperationException e) {
  }
  if (mimeType == null) {
    mimeType=guessMimeType(path);
    msg="Guessed MIME type '" + mimeType + "'";
    logger.log(TreeLogger.TRACE,msg,null);
  }
  InputStream is=null;
  try {
    URLConnection conn=foundResource.openConnection();
    long lastModified=conn.getLastModified();
    if (isNotModified(request,lastModified)) {
      response.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
      return;
    }
    response.setStatus(HttpServletResponse.SC_OK);
    long now=new Date().getTime();
    response.setHeader(HttpHeaders.DATE,HttpHeaders.toInternetDateFormat(now));
    response.setContentType(mimeType);
    String lastModifiedStr=HttpHeaders.toInternetDateFormat(lastModified);
    response.setHeader(HttpHeaders.LAST_MODIFIED,lastModifiedStr);
    final long jan2nd1980=315637200000L;
    String inThePastStr=HttpHeaders.toInternetDateFormat(jan2nd1980);
    response.setHeader(HttpHeaders.EXPIRES,inThePastStr);
    is=foundResource.openStream();
    streamOut(is,response.getOutputStream(),1024 * 8);
  }
  finally {
    if (is != null) {
      try {
        is.close();
      }
 catch (      IOException swallowed) {
      }
    }
  }
}
