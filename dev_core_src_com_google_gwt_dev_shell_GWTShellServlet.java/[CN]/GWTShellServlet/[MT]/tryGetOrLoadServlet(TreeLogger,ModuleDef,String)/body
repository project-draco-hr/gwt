{
  Map<String,HttpServlet> moduleServlets;
synchronized (loadedServletsByModuleAndClassName) {
    moduleServlets=loadedServletsByModuleAndClassName.get(moduleDef);
    if (moduleServlets == null) {
      moduleServlets=new HashMap<String,HttpServlet>();
      loadedServletsByModuleAndClassName.put(moduleDef,moduleServlets);
    }
  }
synchronized (moduleServlets) {
    HttpServlet servlet=moduleServlets.get(className);
    if (servlet != null) {
      return servlet;
    }
    Throwable caught=null;
    try {
      Class<?> servletClass=Class.forName(className);
      Object newInstance=servletClass.newInstance();
      if (!(newInstance instanceof HttpServlet)) {
        logger.log(TreeLogger.ERROR,"Not compatible with HttpServlet: " + className + " (does your service extend RemoteServiceServlet?)",null);
        return null;
      }
      servlet=(HttpServlet)newInstance;
      ServletContext context=new HostedModeServletContextProxy(getServletContext(),moduleDef,getShellWorkDirs());
      ServletConfig config=new HostedModeServletConfigProxy(getServletConfig(),context);
      servlet.init(config);
      moduleServlets.put(className,servlet);
      return servlet;
    }
 catch (    ClassNotFoundException e) {
      caught=e;
    }
catch (    InstantiationException e) {
      caught=e;
    }
catch (    IllegalAccessException e) {
      caught=e;
    }
catch (    ServletException e) {
      caught=e;
    }
    String msg="Unable to instantiate '" + className + "'";
    logger.log(TreeLogger.ERROR,msg,caught);
    return null;
  }
}
