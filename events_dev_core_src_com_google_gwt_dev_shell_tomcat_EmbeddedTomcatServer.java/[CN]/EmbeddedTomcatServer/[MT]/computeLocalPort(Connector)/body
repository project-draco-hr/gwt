{
  Throwable caught=null;
  try {
    Field phField=CoyoteConnector.class.getDeclaredField("protocolHandler");
    phField.setAccessible(true);
    Object protocolHandler=phField.get(connector);
    Field epField=protocolHandler.getClass().getDeclaredField("ep");
    epField.setAccessible(true);
    Object endPoint=epField.get(protocolHandler);
    Field ssField=endPoint.getClass().getDeclaredField("serverSocket");
    ssField.setAccessible(true);
    ServerSocket serverSocket=(ServerSocket)ssField.get(endPoint);
    return serverSocket.getLocalPort();
  }
 catch (  SecurityException e) {
    caught=e;
  }
catch (  NoSuchFieldException e) {
    caught=e;
  }
catch (  IllegalArgumentException e) {
    caught=e;
  }
catch (  IllegalAccessException e) {
    caught=e;
  }
  throw new RuntimeException("Failed to retrieve the startup port from Embedded Tomcat",caught);
}
