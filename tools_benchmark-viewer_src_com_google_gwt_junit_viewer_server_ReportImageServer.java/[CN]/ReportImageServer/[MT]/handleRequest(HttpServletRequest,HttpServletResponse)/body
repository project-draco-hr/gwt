{
  String uri=request.getRequestURI();
  String requestString=uri.split("test_images/")[1];
  String[] requestParams=requestString.split("/");
  String reportName=URLDecoder.decode(requestParams[0],charset);
  String categoryName=URLDecoder.decode(requestParams[1],charset);
  String testName=URLDecoder.decode(requestParams[3],charset);
  String agent=URLDecoder.decode(requestParams[4],charset);
  ReportDatabase db=ReportDatabase.getInstance();
  Report report=db.getReport(reportName);
  List categories=report.getCategories();
  Category category=getCategoryByName(categories,categoryName);
  List benchmarks=category.getBenchmarks();
  Benchmark benchmark=getBenchmarkByName(benchmarks,testName);
  List results=benchmark.getResults();
  Result result=getResultsByAgent(results,agent);
  String title=BrowserInfo.getBrowser(agent);
  JFreeChart chart=createChart(testName,result,title,results);
  chart.getTitle().setFont(Font.decode("Verdana BOLD 12"));
  chart.setAntiAlias(true);
  chart.setBorderVisible(true);
  chart.setBackgroundPaint(new Color(241,241,241));
  Plot plot=chart.getPlot();
  plot.setDrawingSupplier(getDrawingSupplier());
  plot.setBackgroundPaint(new GradientPaint(0,0,Color.white,640,480,new Color(200,200,200)));
  if (plot instanceof XYPlot) {
    XYPlot xyplot=(XYPlot)plot;
    Font labelFont=Font.decode("Verdana PLAIN");
    xyplot.getDomainAxis().setLabelFont(labelFont);
    xyplot.getRangeAxis().setLabelFont(labelFont);
    org.jfree.chart.renderer.xy.XYItemRenderer xyitemrenderer=xyplot.getRenderer();
    xyitemrenderer.setStroke(new BasicStroke(4));
    if (xyitemrenderer instanceof XYLineAndShapeRenderer) {
      XYLineAndShapeRenderer xylineandshaperenderer=(XYLineAndShapeRenderer)xyitemrenderer;
      xylineandshaperenderer.setShapesVisible(true);
      xylineandshaperenderer.setShapesFilled(true);
    }
  }
  final int graphWidth=Math.max(240,Math.min(480,(1024 - 10 * results.size()) / results.size()));
  BufferedImage img=chart.createBufferedImage(graphWidth,240);
  byte[] image=EncoderUtil.encode(img,ImageFormat.PNG);
  response.setContentType("image/png");
  OutputStream output=response.getOutputStream();
  copy(new ByteArrayInputStream(image),output);
}
