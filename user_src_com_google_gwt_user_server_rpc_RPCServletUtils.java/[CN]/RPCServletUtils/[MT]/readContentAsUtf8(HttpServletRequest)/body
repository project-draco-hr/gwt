{
  int contentLength=request.getContentLength();
  if (contentLength == -1) {
    throw new ServletException("Content-Length must be specified");
  }
  String contentType=request.getContentType();
  boolean contentTypeIsOkay=false;
  if (contentType != null) {
    contentType=contentType.toLowerCase();
    if (contentType.startsWith("text/plain")) {
      if (contentType.indexOf("charset=") == -1) {
        contentTypeIsOkay=true;
      }
 else       if (contentType.indexOf("charset=utf-8") != -1) {
        contentTypeIsOkay=true;
      }
    }
  }
  if (!contentTypeIsOkay) {
    throw new ServletException("Content-Type must be 'text/plain' with 'charset=utf-8' (or unspecified charset)");
  }
  InputStream in=request.getInputStream();
  try {
    byte[] payload=new byte[contentLength];
    int offset=0;
    int len=contentLength;
    int byteCount;
    while (offset < contentLength) {
      byteCount=in.read(payload,offset,len);
      if (byteCount == -1) {
        throw new ServletException("Client did not send " + contentLength + " bytes as expected");
      }
      offset+=byteCount;
      len-=byteCount;
    }
    return new String(payload,CHARSET_UTF8);
  }
  finally {
    if (in != null) {
      in.close();
    }
  }
}
